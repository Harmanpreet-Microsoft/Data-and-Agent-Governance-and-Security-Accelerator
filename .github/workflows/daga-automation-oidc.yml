name: DSPM Automation (OIDC)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  run-automation:
    runs-on: ubuntu-latest
    env:
      SPEC_PATH: ./spec.ci.json
    steps:
      - name: Check M365 cert availability
        id: check_cert
        run: |
          if [ -n "${{ secrets.DAGA_M365_CERT_PFX }}" ]; then
            echo "has_cert=true" >> $GITHUB_OUTPUT
          else
            echo "has_cert=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (federated)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_FEDERATED_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_FEDERATED_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_FEDERATED_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Write DSPM spec from secret
        shell: pwsh
        run: |
          $spec = @'
          ${{ secrets.DAGA_SPEC_JSON }}
          '@
          if ([string]::IsNullOrWhiteSpace($spec)) {
            throw 'DAGA_SPEC_JSON secret is empty or missing.'
          }
          $spec | Out-File -FilePath $env:SPEC_PATH -Encoding utf8

      - name: Materialize Exchange certificate
        if: steps.check_cert.outputs.has_cert == 'true'
        shell: pwsh
        env:
          CERT_PATH: ${{ runner.temp }}/daga-exo-cert.pfx
        run: |
          $bytes = [Convert]::FromBase64String('${{ secrets.DAGA_M365_CERT_PFX }}')
          [System.IO.File]::WriteAllBytes('$env:CERT_PATH', $bytes)

      - name: Install PowerShell modules
        shell: pwsh
        run: |
          Install-Module Az -Scope CurrentUser -Force -AllowClobber
          Install-Module Az.Security -Scope CurrentUser -Force -AllowClobber
          Install-Module Az.Purview -Scope CurrentUser -Force -AllowClobber
          Install-Module ExchangeOnlineManagement -Scope CurrentUser -Force

      - name: Ensure Purview account exists
        shell: pwsh
        run: |
          $spec = Get-Content $env:SPEC_PATH -Raw | ConvertFrom-Json
          $purviewSubId = if ($spec.purviewSubscriptionId) { $spec.purviewSubscriptionId } else { $spec.subscriptionId }
          $purviewRg = if ($spec.purviewResourceGroup) { $spec.purviewResourceGroup } else { $spec.resourceGroup }
          $location = $spec.location
          
          Set-AzContext -SubscriptionId $purviewSubId | Out-Null
          
          # Register Microsoft.Purview resource provider if needed
          $provider = Get-AzResourceProvider -ProviderNamespace Microsoft.Purview
          if ($provider.RegistrationState -ne 'Registered') {
            Write-Host "Registering Microsoft.Purview resource provider..." -ForegroundColor Yellow
            Register-AzResourceProvider -ProviderNamespace Microsoft.Purview | Out-Null
            
            # Wait for registration to complete
            $timeout = 300 # 5 minutes
            $elapsed = 0
            while ($elapsed -lt $timeout) {
              $provider = Get-AzResourceProvider -ProviderNamespace Microsoft.Purview
              if ($provider.RegistrationState -eq 'Registered') {
                Write-Host "Microsoft.Purview registered successfully" -ForegroundColor Green
                break
              }
              Start-Sleep -Seconds 10
              $elapsed += 10
            }
            if ($provider.RegistrationState -ne 'Registered') {
              throw "Microsoft.Purview registration timed out"
            }
          }
          
          # Check if the specified Purview account exists
          $existing = Get-AzPurviewAccount -Name $spec.purviewAccount -ResourceGroupName $purviewRg -ErrorAction SilentlyContinue
          
          if ($existing) {
            Write-Host "✓ Purview account '$($spec.purviewAccount)' found and accessible" -ForegroundColor Green
          } else {
            Write-Error "✗ Purview account '$($spec.purviewAccount)' not found in subscription '$purviewSubId' / resource group '$purviewRg'"
            Write-Error ""
            Write-Error "The workflow cannot continue without a Purview account."
            Write-Error ""
            Write-Error "To fix this:"
            Write-Error "1. Find your existing Purview account:"
            Write-Error "   Get-AzPurviewAccount | Select-Object Name, ResourceGroupName"
            Write-Error ""
            Write-Error "2. Update the DAGA_SPEC_JSON secret with the correct values:"
            Write-Error "   - purviewAccount: <actual-account-name>"
            Write-Error "   - purviewResourceGroup: <actual-resource-group>"
            Write-Error ""
            Write-Error "3. Grant your service principal Reader access to the Purview account"
            Write-Error ""
            throw "Purview account not found. Workflow stopped."
          }

      - name: Run DSPM accelerator
        shell: pwsh
        env:
          DAGA_SPEC_PATH: ${{ env.SPEC_PATH }}
          DAGA_M365_APP_ID: ${{ secrets.DAGA_M365_APP_ID }}
          DAGA_M365_ORGANIZATION: ${{ secrets.DAGA_M365_ORGANIZATION }}
          DAGA_M365_CERT_PATH: ${{ runner.temp }}/daga-exo-cert.pfx
          DAGA_M365_CERT_PASSWORD: ${{ secrets.DAGA_M365_CERT_PASSWORD }}
        run: |
          # Run automation - will fail fast if Purview validation failed above
          $m365Flag = if ('${{ steps.check_cert.outputs.has_cert }}' -eq 'true') { '-ConnectM365' } else { '' }
          $command = "./run.ps1 -Tags foundation,dspm,defender,foundry -SpecPath `$env:DAGA_SPEC_PATH $m365Flag"
          Write-Host "Running: $command" -ForegroundColor Cyan
          Invoke-Expression $command
        timeout-minutes: 30

      - name: Cleanup cert
        if: steps.check_cert.outputs.has_cert == 'true'
        shell: pwsh
        env:
          CERT_PATH: ${{ runner.temp }}/daga-exo-cert.pfx
        run: |
          if (Test-Path '$env:CERT_PATH') {
            Remove-Item '$env:CERT_PATH' -Force
          }

